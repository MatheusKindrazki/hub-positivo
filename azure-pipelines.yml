trigger:
  branches:
    include:
    - refs/heads/develop
    - refs/heads/homolog
    - refs/heads/master
name: $(date:yyyyMMdd)$(rev:.r)

variables:
  YARN_CACHE_FOLDER: $(Pipeline.Workspace)/.yarn
  uiSource: 'src'
  uiBuild: '$(uiSource)/build'
  ${{ if eq(variables['Build.SourceBranchName'], 'master') }}:
    stageName: prod
  ${{ if eq(variables['Build.SourceBranchName'], 'develop') }}:
    stageName: dev
  ${{ if eq(variables['Build.SourceBranchName'], 'homolog') }}:
    stageName: hml

pool:
  vmImage: ubuntu-16.04

jobs:
- job: build_and_generate_artifact
  displayName: "Building and generating the artifact"

  steps:

  - task: SonarCloudPrepare@1
    inputs:
      SonarCloud: 'hub-sonarcloud'
      organization: 'editorati'
      scannerMode: 'CLI'
      configMode: 'manual'
      cliProjectKey: 'editorati_HubDigitalFront'
      cliProjectName: 'HubDigitalFront'
      cliSources: '.'
      extraProperties: |
        sonar.sources=packages/apps/hub-web/src/components,packages/apps/hub-web/src/pages,packages/apps/hub-web/src/services,packages/apps/hub-web/src/store/modules,packages/apps/hub-web/src/utils,packages/apps/hub-web/src/validators,packages/apps/hub-web/src/middlewares,packages/apps/hub-web/src/hooks,packages/common/components
        sonar.exclusions=**/*.spec.ts,**/*.spec.tsx,**/types.ts,**/*.d.ts,**/mock.ts,
        sonar.coverage.exclusions=**/*.spec.ts,**/*.spec.tsx,**/types.ts,**/*.d.ts,**/mock.ts,
        sonar.javascript.lcov.reportPaths=coverage/lcov.info
        sonar.testExecutionReportPaths=test-report.xml
        sonar.test.inclusions=packages/apps/hub-web/src/**/*.spec.tsx,packages/apps/hub-web/src/**/*.spec.ts,packages/common/**/*.spec.tsx,packages/apps/common/**/*.spec.ts

  - task: DownloadSecureFile@1
    displayName: "Download env file"
    name: envFile
    inputs:
      secureFile: 'env-hub-$(stageName)'

  - script: |
      cp $(envFile.secureFilePath) ./packages/apps/hub-web/.env
    displayName: "Copy env file"

  - task: NodeTool@0
    displayName: Installing node 14+
    inputs:
      versionSpec: 14.x

  - task: YarnInstaller@3
    displayName: Configuring yarn in its recent version

  - task: Cache@2
    inputs:
      key: yarn | $(Agent.OS) | yarn.lock | node_modules
      path: $(YARN_CACHE_FOLDER)
      restoreKeys: |
        yarn | $(Agent.OS)
        yarn
    displayName: Cache Yarn packages

  - script: yarn
    displayName: Installing project dependencies

  - task: Yarn@3
    displayName: Running the project tests
    inputs:
      arguments: test:coverage

  - task: SonarCloudAnalyze@1

  - script: |
      export GH_TOKEN=$(GH_TOKEN) && set GH_TOKEN=$(GH_TOKEN) && yarn release
    displayName: Semantic Release ( generate changelog and build tag )
    condition: eq(variables['Build.SourceBranchName'], 'master')

  - script: |
      node ./scripts/update-version.js
    displayName: Updating production version

  - task: Yarn@3
    displayName: Build the project
    inputs:
      arguments: build:web

  - task: ArchiveFiles@2
    displayName: Archive files
    inputs:
      rootFolderOrFile: $(System.DefaultWorkingDirectory)/packages/apps/hub-web/build
      includeRootFolder: false

  - task: PublishBuildArtifacts@1
    displayName: 'Publish artifacts: hub'
    inputs:
      ArtifactName: devhubdigital
      TargetPath: '\\my\share\$(Build.DefinitionName)\$(Build.BuildNumber)'
