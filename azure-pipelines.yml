trigger:
  branches:
    include:
    - refs/heads/develop
    - refs/heads/homolog
    - refs/heads/master
name: $(date:yyyyMMdd)$(rev:.r)

variables:
  uiSource: 'src'
  uiBuild: '$(uiSource)/build'
  ${{ if eq(variables['Build.SourceBranchName'], 'master') }}:
    stageName: prod
  ${{ if eq(variables['Build.SourceBranchName'], 'develop') }}:
    stageName: dev
  ${{ if eq(variables['Build.SourceBranchName'], 'homolog') }}:
    stageName: hml

pool:
  vmImage: ubuntu-16.04

jobs:
- job: build_and_generate_artifact
  displayName: "Building and generating the artifact"

  steps:

  - task: SonarCloudPrepare@1
    displayName: SonarCloud Prepare
    inputs:
      SonarCloud: 'SonarCloud'
      organization: 'editorati'
      scannerMode: 'CLI'
      configMode: 'manual'
      cliProjectKey: 'editorati_HubDigitalFront'
      cliProjectName: 'HubDigitalFront'
      cliSources: '.'

  - task: DownloadSecureFile@1
    displayName: "Download env file"
    name: envFile
    inputs:
      secureFile: 'env-hub-$(stageName)'

  - script: |
      cp $(envFile.secureFilePath) ./packages/apps/hub-web/.env
    displayName: "Copy env file"

  - task: NodeTool@0
    displayName: Installing node 14+
    inputs:
      versionSpec: 14.x

  - task: YarnInstaller@3
    displayName: Configuring yarn in its recent version

  - task: Yarn@3
    displayName: Installing project dependencies
    inputs:
      arguments: install

  - task: Yarn@3
    displayName: Running the project tests
    inputs:
      arguments: test

  - script: |
      export GH_TOKEN=$(GH_TOKEN) && set GH_TOKEN=$(GH_TOKEN) && yarn release
    displayName: Semantic Release ( generate changelog and build tag )
    condition: eq(variables['Build.SourceBranchName'], 'master')

  - task: Yarn@3
    displayName: Build the project
    inputs:
      arguments: build:web

  - task: ArchiveFiles@2
    displayName: Archive files
    inputs:
      rootFolderOrFile: $(System.DefaultWorkingDirectory)/packages/apps/hub-web/build
      includeRootFolder: false

  - task: PublishBuildArtifacts@1
    displayName: 'Publish artifacts: hub'
    inputs:
      ArtifactName: devhubdigital
      TargetPath: '\\my\share\$(Build.DefinitionName)\$(Build.BuildNumber)'
